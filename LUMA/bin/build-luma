#!/bin/bash

# Build a LUMA executable from a definitions.h file

set -eu

defsfile="$1"
makedefsfile="$2"
destexe="$3"

shift 3
makeargs="${@}"

tmpdir=$(mktemp -d -t luma-XXXXXXXXXX)
mkdir $tmpdir/inc
mkdir $tmpdir/obj

trap "rm -rf $tmpdir" EXIT

cp $defsfile $tmpdir/inc

lumadir=$(dirname $(dirname ${BASH_SOURCE}))

make -C $lumadir -B -j 8 \
     MAKEDEFS="$(readlink -f $makedefsfile)" \
     EXE=$(readlink -f $destexe) \
     ODIR=$tmpdir/obj \
     INC_DEFINITIONS="-I$tmpdir/inc" \
     $makeargs

rm -rf $tmpdir
